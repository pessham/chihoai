name: Test PR Build

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  test-build:
    runs-on: ubuntu-latest
    name: Test Build and Deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies (if package.json exists)
        run: |
          if [ -f package.json ]; then
            npm ci
            echo "âœ… Dependencies installed"
          else
            echo "â„¹ï¸ No package.json found, skipping npm install"
          fi
          
      - name: Test CMS Build Process
        run: |
          echo "ğŸ”¨ Testing CMS build process..."
          if [ -f system/cms/tools/generate-contents.js ]; then
            cd system/cms && node tools/generate-contents.js
            echo "âœ… CMS build successful"
          else
            echo "â„¹ï¸ No CMS build script found"
          fi
          
      - name: Validate HTML Files
        run: |
          echo "ğŸŒ Validating HTML files..."
          html_files=$(find public -name "*.html" | wc -l)
          echo "Found $html_files HTML files"
          
          # åŸºæœ¬çš„ãªHTMLæ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯
          for file in public/articles/*.html; do
            if [ -f "$file" ]; then
              if ! grep -q "</html>" "$file"; then
                echo "âŒ Missing closing </html> tag in $file"
                exit 1
              fi
            fi
          done
          echo "âœ… HTML validation passed"
          
      - name: Check Static Assets
        run: |
          echo "ğŸ“ Checking static assets..."
          
          # å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
          required_dirs=("public/images" "public/css" "public/js")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âš ï¸ Directory $dir not found"
            else
              echo "âœ… $dir exists"
            fi
          done
          
      - name: Security Pre-check
        run: |
          echo "ğŸ” Running basic security pre-checks..."
          
          # å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ>10MBï¼‰
          large_files=$(find . -size +10M -not -path "./.git/*" -not -path "./node_modules/*")
          if [ -n "$large_files" ]; then
            echo "âš ï¸ Large files found:"
            echo "$large_files"
          else
            echo "âœ… No unusually large files found"
          fi
          
          # å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
          exec_files=$(find . -type f -perm -111 -not -path "./.git/*" -not -path "./node_modules/*" | head -5)
          if [ -n "$exec_files" ]; then
            echo "â„¹ï¸ Executable files found:"
            echo "$exec_files"
          fi
          
      - name: PR Summary
        run: |
          echo "## ğŸ“Š PR Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build process completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… HTML validation passed" >> $GITHUB_STEP_SUMMARY  
          echo "- âœ… Basic security checks passed" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ Awaiting Claude AI security review..." >> $GITHUB_STEP_SUMMARY