name: Claude Code Security Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ main, develop ]
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®è€ƒæ…®äº‹é …
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  security-review:
    runs-on: ubuntu-latest
    name: AI-Powered Security Analysis
    
    # ãƒ•ã‚©ãƒ¼ã‚¯ã‹ã‚‰ã®PRã§ã¯å®Ÿè¡Œã—ãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã®ãŸã‚ï¼‰
    if: github.event.pull_request.head.repo.full_name == github.repository
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          # ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ã®è©³ç´°åˆ†æã®ãŸã‚ã€å±¥æ­´ã‚’å–å¾—
          fetch-depth: 0
          
      - name: Run Claude Security Review
        uses: anthropics/claude-code-security-review@main
        with:
          # PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          comment-pr: true
          # é‡è¦åº¦ã®é«˜ã„è„†å¼±æ€§ã®ã¿ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
          min-severity: 'medium'
          # åˆ†æå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥ã‚’æŒ‡å®š
          file-patterns: |
            **/*.js
            **/*.ts
            **/*.html
            **/*.php
            **/*.py
            **/*.md
            **/.env*
            **/config/**
            **/system/**
          # Claude APIã‚­ãƒ¼ï¼ˆGitHubã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰å–å¾—ï¼‰
          claude-api-key: ${{ secrets.CLAUDE_API_KEY }}
          
      - name: Security Review Summary
        if: always()
        run: |
          echo "ğŸ” Claude AI Security Review completed"
          echo "ğŸ“‹ Check the PR comments for detailed security analysis"
          echo "ğŸ›¡ï¸ Review any identified security concerns before merging"

  # è¿½åŠ ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
  additional-security-checks:
    runs-on: ubuntu-latest
    name: Additional Security Checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Check for sensitive data
        run: |
          echo "ğŸ” Scanning for potential secrets and sensitive data..."
          
          # API ã‚­ãƒ¼ã‚„ç§˜åŒ¿æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          if grep -r -i -E "(api[_-]?key|secret|password|token)" --include="*.js" --include="*.ts" --include="*.html" --include="*.md" . | grep -v ".github" | grep -v "node_modules"; then
            echo "âš ï¸ Potential secrets found in code. Please review:"
            grep -r -i -E "(api[_-]?key|secret|password|token)" --include="*.js" --include="*.ts" --include="*.html" --include="*.md" . | grep -v ".github" | grep -v "node_modules" | head -10
          else
            echo "âœ… No obvious secrets found in code"
          fi
          
      - name: Check file permissions
        run: |
          echo "ğŸ“ Checking file permissions..."
          find . -type f -perm -002 -not -path "./.git/*" -not -path "./node_modules/*" | head -10 || echo "âœ… No world-writable files found"
          
      - name: Validate HTML structure
        run: |
          echo "ğŸŒ Validating HTML files for security..."
          # å±é™ºãªHTMLãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          if find public/articles -name "*.html" -exec grep -l "javascript:" {} \;; then
            echo "âš ï¸ Found javascript: URLs in HTML files"
          fi
          if find public/articles -name "*.html" -exec grep -l "eval(" {} \;; then
            echo "âš ï¸ Found eval() calls in HTML files"
          fi
          echo "âœ… HTML security check completed"

  # npm/Nodeãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ï¼ˆpackage.jsonãŒã‚ã‚‹å ´åˆï¼‰
  dependency-security:
    runs-on: ubuntu-latest
    name: Dependency Security Audit
    if: hashFiles('package.json') != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run security audit
        run: |
          echo "ğŸ“¦ Running npm security audit..."
          npm audit --audit-level=moderate || echo "âš ï¸ Security vulnerabilities found in dependencies"
          
      - name: Check for outdated packages
        run: |
          echo "ğŸ”„ Checking for outdated packages..."
          npm outdated || echo "ğŸ“‹ Some packages may be outdated"